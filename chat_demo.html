<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天界面演示</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .login-section, .chat-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .hidden { display: none; }
        input, button { margin: 5px; padding: 8px; }
        .message { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>ToDoList 聊天系统演示</h1>
    
    <!-- 登录部分 -->
    <div id="loginSection" class="login-section">
        <h2>用户登录</h2>
        <input type="text" id="username" placeholder="用户名" value="testuser">
        <input type="password" id="password" placeholder="密码" value="password123">
        <button onclick="login()">登录</button>
        <div id="loginResult"></div>
    </div>
    
    <!-- 聊天部分 -->
    <div id="chatSection" class="chat-section hidden">
        <h2>聊天室 (房间ID: 1)</h2>
        <button onclick="loadMessages()">加载消息</button>
        <button onclick="logout()">退出登录</button>
        
        <div id="chatResult"></div>
        
        <h3>发送消息</h3>
        <input type="text" id="messageContent" placeholder="输入消息内容">
        <button onclick="sendMessage()">发送</button>
        <div id="sendResult"></div>
        
        <h3>消息列表</h3>
        <div id="messagesList"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let authToken = null;
        
        // 登录功能
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // ✅ 保存认证Token
                    authToken = result.token;
                    localStorage.setItem('authToken', authToken);
                    
                    document.getElementById('loginResult').innerHTML = 
                        `<span class="success">登录成功！Token: ${authToken}</span>`;
                    
                    // 显示聊天界面
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('chatSection').classList.remove('hidden');
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        `<span class="error">登录失败: ${result.message}</span>`;
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    `<span class="error">请求错误: ${error.message}</span>`;
            }
        }
        
        // 加载消息列表
        async function loadMessages() {
            if (!authToken) {
                alert('请先登录！');
                return;
            }
            
            try {
                // ✅ 在请求头中添加认证Token
                const response = await fetch(`${API_BASE}/chat/rooms/1/messages`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`  // 关键：添加认证头
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayMessages(result.messages || []);
                    document.getElementById('chatResult').innerHTML = 
                        `<span class="success">消息加载成功！</span>`;
                } else {
                    document.getElementById('chatResult').innerHTML = 
                        `<span class="error">加载失败: ${result.message}</span>`;
                }
            } catch (error) {
                document.getElementById('chatResult').innerHTML = 
                    `<span class="error">请求错误: ${error.message}</span>`;
            }
        }
        
        // 发送消息
        async function sendMessage() {
            const content = document.getElementById('messageContent').value;
            if (!content.trim()) {
                alert('请输入消息内容！');
                return;
            }
            
            if (!authToken) {
                alert('请先登录！');
                return;
            }
            
            try {
                // ✅ 在请求头中添加认证Token
                const response = await fetch(`${API_BASE}/chat/rooms/1/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`  // 关键：添加认证头
                    },
                    body: JSON.stringify({ content })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('sendResult').innerHTML = 
                        `<span class="success">消息发送成功！</span>`;
                    document.getElementById('messageContent').value = '';
                    loadMessages(); // 重新加载消息
                } else {
                    document.getElementById('sendResult').innerHTML = 
                        `<span class="error">发送失败: ${result.message}</span>`;
                }
            } catch (error) {
                document.getElementById('sendResult').innerHTML = 
                    `<span class="error">请求错误: ${error.message}</span>`;
            }
        }
        
        // 显示消息列表
        function displayMessages(messages) {
            const messagesList = document.getElementById('messagesList');
            if (!messages || messages.length === 0) {
                messagesList.innerHTML = '<p>暂无消息</p>';
                return;
            }
            
            messagesList.innerHTML = messages.map(msg => `
                <div class="message">
                    <strong>${msg.senderName}</strong> (${new Date(msg.timestamp).toLocaleString()}):<br>
                    ${msg.content}
                </div>
            `).join('');
        }
        
        // 退出登录
        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('chatSection').classList.add('hidden');
            document.getElementById('loginResult').innerHTML = '';
        }
        
        // 页面加载时检查是否有保存的Token
        window.onload = function() {
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                authToken = savedToken;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('chatSection').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>